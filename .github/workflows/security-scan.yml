# =============================================================================
# Security Scanning Workflow - Continuum Knowledge Management Platform
# =============================================================================
# Runs security scans on a schedule and for pull requests
# Includes: Dependency scanning, secret scanning, SAST
# =============================================================================
name: Security Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: "0 2 * * *"
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # ===========================================================================
  # Dependency Vulnerability Scanning
  # ===========================================================================
  dependency-scan-backend:
    name: Scan Backend Dependencies
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety

      - name: Run pip-audit
        run: |
          pip-audit --desc on --format json --output pip-audit-report.json || true
          cat pip-audit-report.json

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: apps/api/pip-audit-report.json
          retention-days: 30

      - name: Run Safety check
        run: |
          pip install -e .
          safety check --json --output safety-report.json || true
          cat safety-report.json

      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: apps/api/safety-report.json
          retention-days: 30

  dependency-scan-frontend:
    name: Scan Frontend Dependencies
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: apps/web/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: |
          pnpm audit --json > npm-audit-report.json || true
          cat npm-audit-report.json

      - name: Upload npm audit report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: apps/web/npm-audit-report.json
          retention-days: 30

  # ===========================================================================
  # SAST - Static Application Security Testing
  # ===========================================================================
  sast-backend:
    name: SAST Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit SAST scan
        run: |
          bandit -r . -x ./tests -f json -o bandit-sast-report.json || true
          bandit -r . -x ./tests -f html -o bandit-sast-report.html || true

      - name: Upload Bandit reports
        uses: actions/upload-artifact@v4
        with:
          name: bandit-sast-reports
          path: |
            apps/api/bandit-sast-report.json
            apps/api/bandit-sast-report.html
          retention-days: 30

      - name: Check for high severity issues
        run: |
          HIGH_COUNT=$(cat bandit-sast-report.json | jq '[.results[] | select(.issue_severity == "HIGH")] | length')
          if [[ "$HIGH_COUNT" -gt 0 ]]; then
            echo "Found $HIGH_COUNT high severity security issues"
            cat bandit-sast-report.json | jq '.results[] | select(.issue_severity == "HIGH")'
            # Don't fail the build, but warn
          fi

  sast-frontend:
    name: SAST Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    defaults:
      run:
        working-directory: apps/web

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # ===========================================================================
  # Secret Scanning
  # ===========================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  # ===========================================================================
  # License Compliance
  # ===========================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: apps/web/pnpm-lock.yaml

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check frontend licenses
        run: |
          cd apps/web
          pnpm install --frozen-lockfile
          license-checker --json --out ../license-report-frontend.json || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check backend licenses
        run: |
          cd apps/api
          pip install pip-licenses
          pip install -e .
          pip-licenses --format=json --output-file=../license-report-backend.json || true

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            apps/license-report-frontend.json
            apps/license-report-backend.json
          retention-days: 30

  # ===========================================================================
  # Summary Report
  # ===========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      - dependency-scan-backend
      - dependency-scan-frontend
      - sast-backend
      - sast-frontend
      - secret-scan
      - license-check
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Dependencies | ${{ needs.dependency-scan-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Dependencies | ${{ needs.dependency-scan-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend SAST | ${{ needs.sast-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend SAST | ${{ needs.sast-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
